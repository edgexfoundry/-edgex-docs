# Rules on Changes to a Device Profile

## Status

** Proposed **
(as of 10/11/21)

## Context

While the device profile has always been the way to describe a device/sensor and template its communications to the rest of the system, over the course of EdgeX evolution there have been changes in what could change in a profile or its associations.  This document is meant to address the issue of change surrounding device profiles in EdgeX going forward.

### Profile Changes

The table below outlines the current elements of the EdgeX device profile, and the circumstances allowed for change (accomplished via PUT update API call - whether that is add, update or delete elements where applicable).

| Device Profile Property | Type | Allowed Change | Description/Comments |
|-------------------------|------|----------------|----------------------|
| *General Properties* ||||
| Id | string | Never | This uuid is generated by EdgeX and uniquely identifies the profile. |
| Name | string | When unassociated | This required property must be unique to the EdgeX instance and cannot be changed when the profile is associated to a device, reading or event.  The profile name can never be empty and must be unique across the entire EdgeX instance. |
| Manufacturer | string | Anytime | As this property does not affect any functionality other than profile query, this property can be change at any time – to include setting the string to an empty string. |
| Description | string | Anytime | As this property does not affect any functionality other than profile query, this property can be change at any time – to include setting the string to an empty string. |
| Model | string | Anytime | As this property does not affect any functionality other than profile query, this property can be change at any time – to include setting the string to an empty string. |
| Labels | string array | Anytime | As this property does not affect any functionality other than profile query, this property can be change at any time – to include adding, removing or modifying any of the strings to the array of labels. |
| Device Resources | array | Situational | When the device profile is not associated to any device, reading or event, the device resource list can be modified (i.e., adding or removing the associated device resources).  Once the profile is associated to a device, reading or event, only new resources can be added to the array.  Deleting is prohibited.|
| Device Commands | array | Situational | When the device profile is not associated to any device, reading or event, the device commands list can be modified (i.e., adding or removing the associated device resources).  Once the profile is associated to a device, reading or event, only new commands can be added to the array.  Deleting is prohibited.  Device commands are optional and so the array can always be empty. |
| *Device Resource Properties* |||
| Description | string | Anytime | As this property does not affect any functionality, this property can be change at any time – to include setting the string to an empty string. |
| Name | string | Situational | When the device profile is not associated to any device, reading or event, this field can be modified.  It can never be blank and must be unique across the entire profile. |
| IsHidden | bool | Situational | When the device profile is not associated to any device, reading or event, this field can be modified.  This field is optional but is false by default when not provided. |
| Tag | string | Situational | As this property does not affect any functionality, this property can be change at any time – to include setting the string to an empty string. |
| Properties | Resource Properties | Situational | When the device profile is not associated to any device, reading or event, this field can be modified.  Because the ValueType and ReadWrite properties of this field are required, it can never be empty. |
| Attributes | map | Situational | When the device profile is not associated to any device, reading or event, this field can be modified.|
| *Device Command Properties* ||||
| Name | string | Situational | When the device profile is not associated to any device, reading or event, this field can be modified.  It can never be blank and must be unique across the entire profile. |
| IsHidden | bool | Situational | When the device profile is not associated to any device, reading or event, this field can be modified.  This field is optional but is false by default when not provided.|
| ReadWrite | string | Situational | When the device profile is not associated to any device, reading or event, this field can be modified.  This field is required.  As the field is expected to be from an enumeration of R, W and RW, it can never be empty. |
| ResourceOperations | array | Situational | When the device profile is not associated to any device, reading or event, this field can be modified.  This field is required and can never be empty. |

 
### Empty Profile

A device profile can begin life “empty” - meaning that it has no device resources or device commands, but only when the profile is not associated to any device, event or reading.  As soon as it is associated to any other EdgeX object, it must have at least one device resource.  Device commands are always optional.

The general properties of a device profile, with the exception of name, are optional when creating an empty profile.

All profiles – even empty profiles – must have a name.                                                                                 

### Deleting Profiles

A profile can only be deleted from metadata when the profile is not associated to any other EdgeX object to include device, provision watcher, event or reading.

### Association Changes

Today, a device profile is associated to a device via its name (the ProfileName on the Device struct).  The profile can also associated to events and readings (via the ProfileName in the Event and Reading objects).

Profiles can be associated to more than one device.  Profiles can be associated to multiple events/readings.

Rules about change of a device profile association have never been explicitly defined.  While the section above outline what can/cannot be changed in the profile and under what circumstances, this section outlines whether a device, event or reading can alter the associated device profile and under what circumstances.

Change of the device profile on a device – never allowed unless there are no events or readings in the system.  There is too much risk that an existing event or reading also contains the device profile reference – causing complexity in knowing what information is in the event/reading.

A provision watcher also has an association to a device profile.  However, the device profile is only used to know the type of device to create in case of provisioning.  Therefore, if a device profile changes, it does not impact the provision watcher.

A device profile cannot be deleted while it is associated to a provision watcher

Change of the device profile on an event or reading is never allowed.  Events and readings are immutable.

## Proposed Design

Pending approval

## Decision

TBD

## Consequences/Considerations

The metadata device profile PUT and DELETE APIs must contain the validation logic per the terms above.

- [Device Profile PUT](https://app.swaggerhub.com/apis/EdgeXFoundry1/core-metadata/2.0.0#/default/put_deviceprofile)
- [Device Profile Upload PUT](https://app.swaggerhub.com/apis/EdgeXFoundry1/core-metadata/2.0.0#/default/put_deviceprofile_uploadfile)
- [Device Profile DELETE](https://app.swaggerhub.com/apis/EdgeXFoundry1/core-metadata/2.0.0#/default/delete_deviceprofile_name__name_)

The device PATCH API must validate that device profile is not changed unless there are no events or readings in core data

- [Device PATCH](https://app.swaggerhub.com/apis/EdgeXFoundry1/core-metadata/2.0.0#/default/patch_device)

The event and reading objects are not allowed to be modified so no change to a device profile would occur.

References

- [Metadata API](https://app.swaggerhub.com/apis/EdgeXFoundry1/core-metadata/2.0.0)
- [Device Service SDK Required Functionality](../../legacy-requirements/device-service.md)
