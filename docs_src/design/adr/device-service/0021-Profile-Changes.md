# Rules on Changes to a Device Profile

## Status

** Proposed **
(as of 10/11/21)

## Context

While the device profile has always been the way to describe a device/sensor and template its communications to the rest of the system, over the course of EdgeX evolution there have been changes in what could change in a profile or its associations.  This document is meant to address the issue of change surrounding device profiles in EdgeX going forward.

### Summary of Allowed changes

A detailed look at the allowed changes to device profile and its device resources is listed below.  In general, here is what we are trying to allow/prevent via these rules:
- Block the DELETE of a device profile when it is associated to any other EdgeX object (device, provision watcher, reading, event) **always**.
- Allow changes to device profile or device resource fields when the field is inconsequential to the object's use (ex: description) or when it is not yet associated to another EdgeX object.  These changes are listed as `Anytime` or `Situational` accordingly in the table below.
- Allow the addition of new profiles, device resources, device commands, etc. **always**.  Additions may be accomplished via POST or PATCH depending on the change and API.

See [Proposed Design section](#proposed-design) section below for specific metadata API changes.

While not explicitly covered in this ADR, a device is not allowed to be deleted when it is associated to an event or reading.

### Profile Changes

The table below outlines the current elements of the EdgeX device profile, and the circumstances allowed for change (accomplished via PUT update API call - whether that is add, update or delete elements where applicable).

| Device Profile Property | Type | Allowed Change | Description/Comments |
|-------------------------|------|----------------|----------------------|
| *General Properties* ||||
| Id | string | Never | This uuid is generated by EdgeX and uniquely identifies the profile. |
| Name | string | Never | This required property must be unique to the EdgeX instance and cannot be changed.  The profile name can never be empty and must be unique across the entire EdgeX instance. |
| Manufacturer | string | Anytime | As this property does not affect any functionality other than profile query, this property can be changed at any time – to include setting the string to an empty string. |
| Description | string | Anytime | As this property does not affect any functionality other than profile query, this property can be changed at any time – to include setting the string to an empty string. |
| Model | string | Anytime | As this property does not affect any functionality other than profile query, this property can be changed at any time – to include setting the string to an empty string. |
| Labels | string array | Anytime | As this property does not affect any functionality other than profile query, this property can be changed at any time – to include adding, removing or modifying any of the strings in the array. |
| Device Resources | array | Situational | New device resources can always be added. Existing device resources can only be removed from the array when the device resource has not yet been associated to any reading or event.|
| Device Commands | array | Situational | New device commands can always be added.  Existing device commands can only be removed from the array when the device command has not yet been associated to a reading or event.  Please see the device command properties for rules on modifying device commands.Device commands are optional and so the array can always be empty. |
| *Device Resource Properties* |||
| Description | string | Anytime | As this property does not affect any functionality, this property can be changed at any time – to include setting the string to an empty string. |
| Name | string | Situational | When the device resource is not associated to any reading or event, this field can be modified.  It can never be blank and must be unique across the entire profile. |
| IsHidden | bool | Anytime | This field allows the device resource to be exposed (default) via the command service.  This change does not affect the behavior but only visibility.  This field is optional but is false by default when not provided. |
| Tag | string | Anytime | As this property does not affect any functionality, this property can be changed at any time – to include setting the string to an empty string. Note: adding or removing a tag could effect queries; that is the same query by tag could return different results if a tag is added or removed between query calls.|
| Properties | Resource Properties | Situational | When the device resource is not associated to any reading or event, this field can be modified.  Because the ValueType and ReadWrite properties of this field are required, it can never be empty. |
| Attributes | map | Anytime | The attributes have no impact on existing readings, events, etc.  They only impact how readings are acquired by the service.|
| *Device Command Properties* ||||
| Name | string | Situational | When the device command is not associated to any reading or event, this field can be modified.  It can never be blank and must be unique across the entire profile. |
| IsHidden | bool | Anytime | This field allows the device command to be exposed (default) via the command service.  This change does not affect the behavior but only visibility.  This field is optional but is false by default when not provided.|
| ReadWrite | string | Anytime | This field has no impact on existing readings, events, etc.  As the field is expected to be from an enumeration of R, W and RW, it can never be empty. |
| ResourceOperations | array | Situational | When the device command is not associated to any reading or event, this field can be modified.  This field is required and can never be empty. |

 
### Empty Profile

A device profile can begin life “empty” - meaning that it has no device resources or device commands.  Once associated to any object (device, event, reading) then, since device resource or device command additions can be made, the empty profile can gain resources or commands.  You can never remove device resources or device commands once the profile's device resources or device commands are associated to another object (event, reading).

The general properties of a device profile, with the exception of name, are optional when creating an empty profile.

All profiles – even empty profiles – must have name.                                                                                 

### Deleting Profiles

A profile can only be deleted from metadata when the profile (or its device resources or device commands) is not associated to any other EdgeX object to include device, provision watcher, event or reading.

### Association Changes

Today, a device profile is associated to a device via its name (the ProfileName on the Device struct).  The profile can also associated to events and readings (via the ProfileName in the Event and Reading objects).

Profiles can be associated to more than one device.  Profiles can be associated to multiple events/readings.

Rules about change of a device profile association have never been explicitly defined.  While the section above outline what can/cannot be changed in the profile and under what circumstances, this section outlines whether a device, event or reading can alter the associated device profile and under what circumstances.

Change of the device profile on a device – never allowed unless there are no events or readings in the system associated to the device profile or its device resources or commands.

A provision watcher also has an association to a device profile.  However, the device profile is only used to know the type of device to create in case of provisioning.  Therefore, if a device profile changes, it does not impact the provision watcher.

A device profile cannot be deleted while it is associated to a provision watcher

Change of the device profile, source name or resource name on an event or reading is never allowed.  Events and readings are immutable.

### Applicability

This document dictates the rules around allowed change to device profiles (and associations).  All checks of these rules are preformed by the service when the APIs are called.  Where in the past, some EdgeX services (including user interface and client tools) performed their own checks and validation with regard to device profile and association changes, this is now forbidden.  The metadata service API will perform the check and return the appropriate error when the check/validation fails.  

## Proposed Design

The following metadata API changes are suggested as a means to implement the device profile rules of this ADR.

- Block Device DELETE when there is any associated event/reading exists.
- Block Profile (Upload) PUT when there is any associated device/event/reading exists.
- Block Profile DELETE when there is any associated device/event/reading exists.
- Allow empty Profile POST (containing no device resources or commands)
- Add Profile General Property PATCH API (allow as described above)
- Add Profile Device Resource POST API
- Add Profile Device Resource PATCH API (allow to modify Description and IsHidden only)
- Add Profile Device Resource DELETE API (allow as described above)
- Add Profile Device Command POST API
- Add Profile Device Command PATCH API (allow as described above)
- Add Profile Device Command DELETE API (allow as described above)

## Decision

TBD

## Consequences/Considerations

No change validation on a device profile PUT will occur based on the terms above.  If you want to add a new device resource, you use the add device   resource API (POST).  You cannot add a device resource through device profile PUT calls unless there are no devices associated to the device profile.

Note, the use of PATCH over PUT in the above APIs (example - the modification of a description on a device resource) is because there can be many device resources (100s or even 1000s) and if you need to change a single description, finding and updating that single device resource would be more time consuming, inefficient and complicated with PUT versus PATCH.  In other words, using PUT, a user would have to send the whole Device Profile in order to modify the single device resource description.

References

- [Metadata API](https://app.swaggerhub.com/apis/EdgeXFoundry1/core-metadata/2.0.0)
- [Device Service SDK Required Functionality](../../legacy-requirements/device-service.md)
